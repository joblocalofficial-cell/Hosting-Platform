<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title> teat12หางาน – JobLocal</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
        /* BASE & LAYOUT (CSS คงเดิมเพื่อความสวยงาม) */
        body { font-family: 'Sukhumvit Set', 'Arial', sans-serif; max-width: 600px; margin: 0 auto; padding: 20px 15px; background-color: #f8f8f8; color: #333; }
        .container { background-color: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); padding: 20px; }

        /* HEADER & PROFILE */
        header { display: flex; gap: 15px; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        #avatar { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; background: #eee; }
        #hello { font-size: 1.1em; font-weight: bold; margin-bottom: 2px; color: #00b900; }
        #uid { font-size: 0.8em; color: #888; }
        
        /* FORM STYLES */
        h2 { font-size: 1.5em; color: #333; margin-top: 25px; margin-bottom: 15px; border-left: 5px solid #00b900; padding-left: 10px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #555; font-size: 0.95em; }
        
        /* INPUTS */
        input, select, textarea { 
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; 
            box-sizing: border-box; font-size: 1em; transition: border-color 0.3s;
            background-color: #fff;
        }
        input:focus, select:focus, textarea:focus { border-color: #00b900; outline: none; box-shadow: 0 0 0 3px rgba(0, 185, 0, 0.1); }
        
        /* GRID LAYOUT */
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 400px) {
            .row { grid-template-columns: 1fr; }
        }

        /* CHECKBOX/PDPA CONSENT */
        .pdpa-group { background-color: #e6ffe6; border: 1px solid #00b900; padding: 15px; border-radius: 8px; margin-bottom: 25px; }
        .pdpa-group label { font-weight: normal; display: flex; align-items: flex-start; margin-bottom: 0; }
        .pdpa-group input[type="checkbox"] { width: auto; margin-right: 10px; margin-top: 2px; }
        .pdpa-consent-text { margin-top: 10px; font-size: 0.85em; }
        .pdpa-consent-text a { color: #008800; text-decoration: none; font-weight: bold; cursor: pointer; }
        
        /* PDPA MODAL STYLES */
        #pdpaModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); display: none; justify-content: center;
            align-items: center; z-index: 1000;
        }
        .modal-content {
            background: #fff; padding: 25px; border-radius: 10px; max-width: 90%;
            max-height: 80%; overflow-y: auto; position: relative;
        }
        .modal-content h3 { color: #00b900; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 0; }
        .modal-content p { font-size: 0.9em; line-height: 1.6; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 20px; cursor: pointer; color: #888; }
        .close-btn:hover { color: #333; }

        /* BUTTON */
        button { 
            background-color: #00b900; color: white; padding: 14px 20px; 
            border: none; border-radius: 8px; cursor: pointer; width: 100%; 
            font-size: 1.1em; font-weight: bold; transition: background-color 0.3s;
        }
        button:hover:enabled { background-color: #008800; }
        button:disabled { background-color: #b3e6b3; cursor: not-allowed; }
        
        /* STATUS */
        .status { margin-top: 10px; font-size: 0.9em; text-align: center; color: #666; }
        .hidden { display: none; }
        
        /* HINT TEXT */
        .hint { font-size: 0.8em; color: #cc0000; margin-top: -15px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img id="avatar" alt="Avatar">
            <div>
                <div id="hello">กำลังเชื่อมต่อ LINE...</div>
                <small id="uid">userId: -</small>
            </div>
        </header>

        <form id="f">
            
            <div class="pdpa-group form-group">
                <label for="consent_pdpa">
                    <input type="checkbox" id="consent_pdpa" name="consent_pdpa" required>
                    **ยืนยัน PDPA** (ยอมรับข้อกำหนดและเงื่อนไข)
                </label>
                <div class="pdpa-consent-text">
                    <a id="showPdpaModal">อ่านเพิ่มเติมเกี่ยวกับข้อความเงื่อนไขการยินยอม</a>
                </div>
            </div>

            <h2>ข้อมูลผู้ว่าจ้าง</h2>
            
            <div class="form-group">
                <label for="user_type">คุณเป็นใคร/องค์กรประเภทใด?</label>
                <select id="user_type" name="user_type" required>
                    <option value="" disabled selected>--- เลือกประเภท ---</option>
                    <option value="บริษัท / องค์กร">บริษัท / องค์กร</option>
                    <option value="บุคคลทั่วไป / เจ้าของกิจการรายย่อย">บุคคลทั่วไป / เจ้าของกิจการรายย่อย</option>
                    <option value="อื่นๆ">อื่นๆ (กรุณาระบุ)</option>
                </select>
            </div>

            <div class="form-group" id="company_org_group">
                <label for="company_or_org">ชื่อบริษัท / ชื่อบุคคลผู้ว่าจ้าง</label>
                <input id="company_or_org" name="company_or_org" placeholder="ระบุชื่อบริษัท / ชื่อบุคคล" required>
            </div>
            
            <div class="row">
                <div class="form-group">
                    <label for="contact_person">ชื่อผู้ติดต่อ</label>
                    <input id="contact_person" name="contact_person" required>
                </div>
                <div class="form-group">
                    <label for="contact_phone">เบอร์โทรศัพท์ติดต่อ (10 หลัก)</label>
                    <input id="contact_phone" name="contact_phone" type="tel" pattern="[0-9]{10}" placeholder="08x-xxxxxxx" required>
                </div>
            </div>

            <h2>ข้อมูลประกาศงาน</h2>

            <div class="row">
                <div class="form-group">
                    <label for="job_title_select">ตำแหน่งงานที่ต้องการจ้าง</label>
                    <select id="job_title_select" name="job_title_select" required>
                        <option value="" disabled selected>--- เลือกตำแหน่ง ---</option>
                        <option value="พนักงานเสิร์ฟ">พนักงานเสิร์ฟ</option>
                        <option value="พนักงานขาย">พนักงานขาย</option>
                        <option value="ช่างซ่อม">ช่างซ่อม</option>
                        <option value="แม่บ้าน">แม่บ้าน</option>
                        <option value="อื่นๆ">อื่นๆ (กรุณาระบุ)</option>
                    </select>
                </div>
                <div class="form-group hidden" id="job_title_other_group">
                    <label for="job_title_other">ตำแหน่งงาน (ระบุ)</label>
                    <input id="job_title_other" name="job_title_other" placeholder="เช่น ผู้จัดการ/แคชเชียร์">
                </div>
                
                <div class="form-group">
                    <label for="job_category">ประเภทงาน/หมวดงาน</label>
                    <select id="job_category" name="job_category" required>
                        <option value="" disabled selected>--- เลือกหมวดงาน ---</option>
                        <option value="งานบริการ (Service)">งานบริการ (Service)</option>
                        <option value="งานขาย (Sales)">งานขาย (Sales)</option>
                        <option value="งานแม่บ้าน / ทำความสะอาด (Housekeeping)">งานแม่บ้าน / ทำความสะอาด (Housekeeping)</option>
                        <option value="งานช่าง / ซ่อมบำรุง (Technician)">งานช่าง / ซ่อมบำรุง (Technician)</option>
                        <option value="งานขับรถ / ส่งของ (Driver)">งานขับรถ / ส่งของ (Driver)</option>
                        <option value="งานครัว / ทำอาหาร (Kitchen)">งานครัว / ทำอาหาร (Kitchen)</option>
                        <option value="งานร้านกาแฟ / ร้านอาหาร (Café & Restaurant)">งานร้านกาแฟ / ร้านอาหาร (Café & Restaurant)</option>
                        <option value="งานทั่วไป / รายวัน (General Labor)">งานทั่วไป / รายวัน (General Labor)</option>
                        <option value="งานออฟฟิศ / ธุรการ (Office / Admin)">งานออฟฟิศ / ธุรการ (Office / Admin)</option>
                        <option value="อื่นๆ">อื่นๆ (กรุณาระบุ)</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="job_description">รายละเอียดงาน / คุณสมบัติ</label>
                <textarea id="job_description" name="job_description" rows="3" placeholder="อธิบายหน้าที่/คุณสมบัติโดยละเอียด"></textarea>
            </div>

            <div class="form-group">
                <label for="location_area">สถานที่ทำงาน / ที่ตั้ง (พิมพ์)</label>
                <input id="location_area" name="location_area" placeholder="พิมพ์ชื่อสถานที่ทำงาน เช่น ร้านอาหาร A สาขาคลองหลวง" required>
            </div>

            <div class="form-group">
                <label for="district">อำเภอ/เขต (ในปทุมธานี)</label>
                <select id="district" name="district" required>
                    <option value="" disabled selected>--- เลือกอำเภอ ---</option>
                    <option value="เมืองปทุมธานี">เมืองปทุมธานี</option>
                    <option value="คลองหลวง">คลองหลวง</option>
                    <option value="ธัญบุรี">ธัญบุรี</option>
                    <option value="หนองเสือ">หนองเสือ</option>
                    <option value="ลาดหลุมแก้ว">ลาดหลุมแก้ว</option>
                    <option value="ลำลูกกา">ลำลูกกา</option>
                    <option value="สามโคก">สามโคก</option>
                </select>
            </div>

            <div class="row">
                <div class="form-group">
                    <label for="headcount">จำนวนคนที่ต้องการ</label>
                    <input id="headcount" name="headcount" type="number" min="1" value="1" required>
                </div>
                <div class="form-group">
                    <label for="wage_type">รูปแบบค่าจ้าง</label>
                    <select id="wage_type" name="wage_type" required>
                        <option value="" disabled selected>--- เลือกรูปแบบ ---</option>
                        <option value="ชั่วโมงละ">ชั่วโมงละ</option>
                        <option value="วันละ">วันละ</option>
                        <option value="เหมาจ้าง">เหมาจ้าง</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group hidden" id="lump_sum_days_group">
                <label for="lump_sum_days">เหมาจ้างเป็นจำนวนกี่วัน?</label>
                <input id="lump_sum_days" name="lump_sum_days" type="number" min="1" placeholder="ใส่จำนวนวัน เช่น 3" required>
            </div>
            
            <div class="form-group">
                <label for="wage_amount">จำนวนค่าจ้าง (ตัวเลขเท่านั้น)</label>
                <input id="wage_amount" name="wage_amount" type="number" inputmode="numeric" placeholder="เช่น 50, 1200, 15000" required>
                <div class="hint">*กรุณากรอกเฉพาะตัวเลข (เช่น 50, 1200)</div>
            </div>
            
            <div class="row">
                <div class="form-group">
                    <label for="start_date">วันที่เริ่มงาน (ถ้ามี)</label>
                    <input id="start_date" name="start_date" type="date">
                </div>
                <div class="form-group">
                    <label for="start_time">เวลาเริ่มงาน</label>
                    <input id="start_time" name="start_time" type="time">
                </div>
            </div>

            <div class="form-group">
                <label for="contact_line_id">LINE ID ผู้ติดต่อ (ถ้ามี)</label>
                <input id="contact_line_id" name="contact_line_id" placeholder="เช่น joblocal_contact">
            </div>

            <button id="submitBtn" type="submit" disabled>กำลังเชื่อมต่อ LINE…</button>
            <div id="status" class="status"></div>
            
            <input type="hidden" name="line_user_id" id="line_user_id">
            <input type="hidden" name="line_display_name" id="line_display_name">
            <input type="hidden" name="job_title" id="job_title_final">
        </form>
    </div>

    <div id="pdpaModal">
        <div class="modal-content">
            <span class="close-btn" id="closePdpaModal">&times;</span>
            <h3>ข้อความเงื่อนไขการยินยอม (สำหรับแบบฟอร์มนายจ้าง)</h3>
            
            <p>ข้าพเจ้าขอให้ความยินยอมในการเก็บรวบรวม ใช้ และเปิดเผยข้อมูลส่วนบุคคล ตามพระราชบัญญัติคุ้มครองข้อมูลส่วนบุคคล พ.ศ. 2562 (“พ.ร.บ. คุ้มครองข้อมูลส่วนบุคคล”) ดังรายละเอียดต่อไปนี้</p>
            
            <h4>1. วัตถุประสงค์ของการเก็บข้อมูล</h4>
            <ul>
                <li>การประกาศงานและการจับคู่งานระหว่างผู้ว่าจ้างและผู้หางานภายในจังหวัดปทุมธานี</li>
                <li>การติดต่อ แจ้งผลการประกาศงาน หรือส่งต่อข้อมูลผู้สมัครที่เหมาะสม</li>
                <li>การตรวจสอบความถูกต้องของข้อมูลและความน่าเชื่อถือของผู้ว่าจ้าง</li>
                <li>การพัฒนาระบบและการให้บริการของโครงการ JobLocal</li>
            </ul>
            
            <h4>2. ประเภทข้อมูลส่วนบุคคลที่เก็บรวบรวม</h4>
            <p>ข้อมูลส่วนบุคคล ได้แก่ ชื่อ-นามสกุล เบอร์โทรศัพท์ อีเมล ชื่อบริษัทหรือชื่อบุคคลผู้ว่าจ้าง ที่อยู่ สถานที่ประกอบการ ช่องทางติดต่อ และข้อมูลอื่นที่เกี่ยวข้องกับการประกาศงาน</p>
            
            <h4>3. การเปิดเผยข้อมูลแก่บุคคลภายนอก</h4>
            <p>ข้อมูลของข้าพเจ้าจะถูกเปิดเผยเฉพาะกับ</p>
            <ul>
                <li>ผู้หางานที่ลงทะเบียนในระบบ JobLocal</li>
                <li>หน่วยงานภาครัฐหรือพันธมิตรโครงการเพื่อวัตถุประสงค์ในการตรวจสอบความถูกต้องของข้อมูล</li>
            </ul>
            <p>ทั้งนี้ จะไม่เปิดเผยข้อมูลเพื่อการค้า หรือส่งต่อให้บุคคลที่สามโดยไม่ได้รับความยินยอม</p>
            
            <h4>4. สิทธิของเจ้าของข้อมูล</h4>
            <p>ข้าพเจ้าทราบดีว่ามีสิทธิในการเข้าถึงข้อมูลส่วนบุคคลของตน ขอแก้ไขข้อมูลให้ถูกต้อง และสามารถถอนความยินยอมได้ทุกเมื่อ โดยติดต่อทีมงาน JobLocal Pathum Thani ผ่านช่องทาง LINE Official Account</p>
            
            <h4>5. ระยะเวลาการเก็บรักษาข้อมูล</h4>
            <p>ข้อมูลจะถูกจัดเก็บไว้นานไม่เกิน 2 ปี นับจากวันที่ส่งแบบฟอร์ม หรือจนกว่าจะมีการขอถอนข้อมูล</p>
            
            <h4>6. การให้ความยินยอม</h4>
            <p>ข้าพเจ้ารับทราบและเข้าใจเงื่อนไขดังกล่าว และยินยอมให้โครงการ JobLocal Pathum Thani เก็บ รวบรวม ใช้ และเปิดเผยข้อมูลส่วนบุคคลของข้าพเจ้าตามวัตถุประสงค์ข้างต้น</p>
        </div>
    </div>


    <script>
        // --- CONFIG ---
        const LIFF_ID = "2008394776-k9v7m3Wg";
        const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyMF_Mm339f1uDEDvYE0gkhO6wBYd2JfVFOPHgW3doUSOP8IHbaE3XiJX28hf7Vh1OV/exec";
        // --- End CONFIG --- 

        const $ = id => document.getElementById(id);
        const form = $("f");

        // ตัวแปรสำหรับเก็บข้อมูลโปรไฟล์ผู้ใช้
        let userProfile = {};
        let userIdToken = '';

        // --- UI Elements ---
        const userTypeSelect = $("user_type");
        const jobTitleSelect = $("job_title_select");
        const jobTitleOtherGroup = $("job_title_other_group");
        const jobTitleOtherInput = $("job_title_other");
        const companyOrgInput = $("company_or_org");
        const pdpaModal = $("pdpaModal");
        const showPdpaModalBtn = $("showPdpaModal");
        const closePdpaModalBtn = $("closePdpaModal");
        
        // --- Wage Elements ---
        const wageTypeSelect = $("wage_type");
        const lumpSumDaysGroup = $("lump_sum_days_group");
        const lumpSumDaysInput = $("lump_sum_days");


        // --- PDPA Modal Handlers ---
        showPdpaModalBtn.addEventListener('click', () => {
            pdpaModal.style.display = 'flex';
        });
        closePdpaModalBtn.addEventListener('click', () => {
            pdpaModal.style.display = 'none';
        });
        pdpaModal.addEventListener('click', (e) => {
            if (e.target.id === 'pdpaModal') {
                pdpaModal.style.display = 'none';
            }
        });

        // --- Conditional Input Handlers ---
        userTypeSelect.addEventListener('change', (e) => {
            const val = e.target.value;
            if (val === 'อื่นๆ' || val === 'บุคคลทั่วไป / เจ้าของกิจการรายย่อย') {
                companyOrgInput.placeholder = "ระบุชื่อบุคคล/กิจการ";
            } else {
                companyOrgInput.placeholder = "ระบุชื่อบริษัท/องค์กร";
            }
        });
        
        jobTitleSelect.addEventListener('change', (e) => {
            if (e.target.value === 'อื่นๆ') {
                jobTitleOtherGroup.classList.remove('hidden');
                jobTitleOtherInput.required = true;
            } else {
                jobTitleOtherGroup.classList.add('hidden');
                jobTitleOtherInput.required = false;
            }
        });

        // --- Wage Conditional Handler ---
        wageTypeSelect.addEventListener('change', (e) => {
            const isLumpSum = e.target.value === 'เหมาจ้าง';
            if (isLumpSum) {
                lumpSumDaysGroup.classList.remove('hidden');
                lumpSumDaysInput.required = true;
            } else {
                lumpSumDaysGroup.classList.add('hidden');
                lumpSumDaysInput.required = false;
                lumpSumDaysInput.value = ''; // Clear value when hidden
            }
        });
        
        // --- LIFF & Form Submission Logic ---
        (async () => {
            try {
                await liff.init({ liffId: LIFF_ID });

                if (!liff.isLoggedIn()) { liff.login(); return; }
                
                userIdToken = liff.getIDToken();

                // 1. ดึง Profile และอัปเดต UI (ใช้ .then() เพื่อให้ไม่บล็อก)
                liff.getProfile().then(p => {
                    userProfile = p; 
                    $("avatar").src = p.pictureUrl || '';
                    $("hello").textContent = `สวัสดี ${p.displayName}`;
                    $("uid").textContent   = `userId: ${p.userId}`;
                    
                    // เติมค่า LIFF ลงใน Hidden Fields
                    $("line_user_id").value = p.userId;
                    $("line_display_name").value = p.displayName;
                    
                    $("submitBtn").textContent = "ส่งประกาศงาน";
                    $("submitBtn").disabled = false;
                }).catch(err => {
                    $("hello").textContent = "❌ ดึงโปรไฟล์ไม่ได้!";
                    $("uid").textContent = "Error: " + err.message;
                    $("submitBtn").textContent = "ไม่สามารถส่งข้อมูลได้";
                    console.error("Error getting profile:", err);
                });

            // 2. จัดการการส่งฟอร์ม (*** โค้ดที่ปรับปรุงเพื่อการ Debug ***)
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const btn = $("submitBtn");
                    const status = $("status");
                    
                    if (!userIdToken || !userProfile.userId) { 
                        status.textContent = "❌ ข้อมูล LINE ไม่สมบูรณ์ กรุณารอหรือลองใหม่"; 
                        liff.login();
                        return; 
                    }
                    
                    // รวบรวมตำแหน่งงานจริง
                    const selectedJobTitle = jobTitleSelect.value;
                    if (selectedJobTitle === 'อื่นๆ') {
                        $("job_title_final").value = jobTitleOtherInput.value;
                    } else {
                        $("job_title_final").value = selectedJobTitle;
                    }

                    btn.disabled = true;
                    status.textContent = "กำลังส่งข้อมูล…";

                    const formData = new FormData(form);
                    // ลบ field ที่ไม่ต้องการส่งไป GAS 
                    formData.delete('job_title_select');
                    formData.delete('job_title_other');
                    
                    // ลบค่า lump_sum_days ถ้าไม่ได้เลือก 'เหมาจ้าง'
                    if (wageTypeSelect.value !== 'เหมาจ้าง') {
                        formData.delete('lump_sum_days');
                    }
                    
                    // เปลี่ยนชื่อ pdpa_confirm
                    formData.set('pdpa_consent', formData.get('consent_pdpa') ? 'ยอมรับ' : 'ไม่ยอมรับ');
                    formData.delete('consent_pdpa');
                    
                    const data = Object.fromEntries(formData.entries());

                    try {
                        const res = await fetch(GAS_ENDPOINT, {
                            method: "POST",
                            headers: {"Content-Type":"application/json"},
                            // ส่งข้อมูล LIFF Profile, ID Token, และ Form Data
                            body: JSON.stringify({ idToken: userIdToken, profile: userProfile, data }) 
                        });
                        
                        // **เพิ่มการตรวจสอบ HTTP Status และ Text Error**
                        if (!res.ok) {
                            const errorText = await res.text();
                            // พิมพ์ Error ใน Console เพื่อการ Debug
                            console.error("HTTP Error Status:", res.status, errorText); 
                            // แสดง Error บนหน้าจอ
                            status.textContent = `❌ ส่งไม่สำเร็จ: Server Error (${res.status})`; 
                            btn.disabled = false;
                            return;
                        }
                        
                        // ถ้าสถานะ OK (200) ให้ลองอ่าน JSON
                        const json = await res.json();
                        
                        if (json.ok) {
                            status.textContent = "✅ ส่งสำเร็จ! ขอบคุณค่ะ";
                            setTimeout(() => { if (liff.closeWindow) liff.closeWindow(); }, 1500);
                        } else {
                            // Error จากโค้ด GAS (เช่น Sheet not found หรือ Processing error)
                            status.textContent = "❌ ส่งไม่สำเร็จ: " + (json.error || "unknown");
                            btn.disabled = false;
                        }
                    } catch (err) {
                        // ดักจับ Network Error (เช่น ไม่มีเน็ต/Timeout) หรือ JSON Parsing Error
                        console.error("Fetch/Processing Error:", err);
                        status.textContent = "❌ เครือข่ายผิดพลาด";
                        btn.disabled = false;
                    }
                });

            } catch (e) {
                console.error(e);
                $("hello").textContent = "ไม่สามารถโหลด LIFF ได้";
                $("uid").textContent   = "";
                $("submitBtn").disabled = true;
                $("submitBtn").textContent = "LIFF Error";
            }
        })();
    </script>
</body>
</html>
