<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>JobLocal - ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏á‡∏≤‡∏ô</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script> 
    
    <style>
        /* CSS Styles */
        body { font-family: 'Sukhumvit Set', 'Arial', sans-serif; max-width: 600px; margin: 0 auto; padding: 20px 15px; background-color: #f8f8f8; color: #333; }
        .container { background-color: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); padding: 20px; }

        /* HEADER & PROFILE */
        header { display: flex; gap: 15px; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        #avatar { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; background: #eee; }
        #hello { font-size: 1.1em; font-weight: bold; margin-bottom: 2px; color: #00b900; }
        #uid { font-size: 0.8em; color: #888; }
        
        /* FORM STYLES */
        h2 { font-size: 1.5em; color: #333; margin-top: 25px; margin-bottom: 15px; border-left: 5px solid #00b900; padding-left: 10px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #555; font-size: 0.95em; }
        
        /* INPUTS */
        input, select, textarea { 
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; 
            box-sizing: border-box; font-size: 1em; transition: border-color 0.3s;
            background-color: #fff;
        }
        input:focus, select:focus, textarea:focus { border-color: #00b900; outline: none; box-shadow: 0 0 0 3px rgba(0, 185, 0, 0.1); }
        
        /* GRID & CHECKBOX/RADIO */
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 400px) { .row { grid-template-columns: 1fr; } }
        
        .radio-group { display: flex; flex-direction: column; gap: 8px; }
        .radio-group label { display: flex; align-items: center; font-weight: normal; margin-bottom: 0; }
        .radio-group input[type="radio"] { width: auto; margin-right: 10px; }

        /* PDPA CONSENT */
        .pdpa-group { background-color: #f0fff0; border: 1px solid #00b900; padding: 15px; border-radius: 8px; margin-bottom: 25px; }
        .pdpa-group label { font-weight: normal; display: flex; align-items: flex-start; margin-bottom: 0; }
        .pdpa-group input[type="checkbox"] { width: auto; margin-right: 10px; margin-top: 2px; }
        
        /* BUTTON */
        button { 
            background-color: #00b900; color: white; padding: 14px 20px; 
            border: none; border-radius: 8px; cursor: pointer; width: 100%; 
            font-size: 1.1em; font-weight: bold; transition: background-color 0.3s;
        }
        button:hover:enabled { background-color: #00a000; }
        button:disabled { background-color: #a0dba0; cursor: not-allowed; }
        
        /* STATUS */
        .status { margin-top: 10px; font-size: 0.9em; text-align: center; color: #666; }
        .hidden { display: none !important; }
        
        /* HISTORY STYLES */
        .history-view h2 { border-left-color: #00b900; }
        .history-view button { background-color: #5bc0de; }
        .history-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-top: 15px; background-color: #f9f9f9; }
        .history-item { margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px dashed #eee; }
        .history-label { font-weight: bold; color: #555; font-size: 0.85em; display: inline-block; width: 150px; }
        .history-value { font-weight: normal; color: #333; font-size: 0.95em; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img id="avatar" alt="Avatar">
            <div>
                <div id="hello">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...</div>
                <small id="uid">userId: -</small>
            </div>
        </header>

        <div id="form-view">
            <form id="f">
                
                <div class="pdpa-group form-group">
                    <label for="pdpa_consent">
                        <input type="checkbox" id="pdpa_consent" name="pdpa_consent" value="‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö" required>
                        **‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô PDPA** (‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç)
                    </label>
                </div>

                <h2>‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á</h2>
                
                <div class="form-group">
                    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á *</label>
                    <div class="radio-group">
                        <label><input type="radio" name="user_type" value="‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£" required> ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£</label>
                        <label><input type="radio" name="user_type" value="‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤"> ‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="company_or_org">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• *</label>
                    <input id="company_or_org" name="company_or_org" required>
                </div>
                
                <div class="row">
                    <div class="form-group">
                        <label for="contact_person">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ *</label>
                        <input id="contact_person" name="contact_person" required>
                    </div>
                    <div class="form-group">
                        <label for="contact_phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå *</label>
                        <input id="contact_phone" name="contact_phone" type="tel" pattern="[0-9]{10}" placeholder="08x-xxxxxxx" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="contact_line_id">LINE ID ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                    <input id="contact_line_id" name="contact_line_id" placeholder="@LineID ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
                </div>

                <h2>‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</h2>

                <div class="form-group">
                    <label for="job_title">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô *</label>
                    <input id="job_title" name="job_title" required>
                </div>

                <div class="form-group">
                    <label for="job_category">‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô *</label>
                    <select id="job_category" name="job_category" required>
                        <option value="" disabled selected>--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô ---</option>
                        <option value="‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£/‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£/‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                        <option value="‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á/‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ">‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á/‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</option>
                        <option value="‡∏á‡∏≤‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£/‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">‡∏á‡∏≤‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£/‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
                        <option value="‡∏á‡∏≤‡∏ô IT/‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•">‡∏á‡∏≤‡∏ô IT/‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</option>
                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="job_description">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô *</label>
                    <textarea id="job_description" name="job_description" rows="4" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="headcount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏≠‡∏±‡∏ï‡∏£‡∏≤) *</label>
                    <input id="headcount" name="headcount" type="number" min="1" required>
                </div>

                <h2>‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á</h2>
                
                <div class="form-group">
                    <label for="location_area">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô *</label>
                    <input id="location_area" name="location_area" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£">
                </div>

                <div class="form-group">
                    <label for="district">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï (‡πÉ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ) *</label>
                    <select id="district" name="district" required>
                        <option value="" disabled selected>--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ---</option>
                        <option value="‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ">‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ</option>
                        <option value="‡∏Ñ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏ß‡∏á">‡∏Ñ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏ß‡∏á</option>
                        <option value="‡∏ò‡∏±‡∏ç‡∏ö‡∏∏‡∏£‡∏µ">‡∏ò‡∏±‡∏ç‡∏ö‡∏∏‡∏£‡∏µ</option>
                        <option value="‡∏´‡∏ô‡∏≠‡∏á‡πÄ‡∏™‡∏∑‡∏≠">‡∏´‡∏ô‡∏≠‡∏á‡πÄ‡∏™‡∏∑‡∏≠</option>
                        <option value="‡∏•‡∏≤‡∏î‡∏´‡∏•‡∏∏‡∏°‡πÅ‡∏Å‡πâ‡∏ß">‡∏•‡∏≤‡∏î‡∏´‡∏•‡∏∏‡∏°‡πÅ‡∏Å‡πâ‡∏ß</option>
                        <option value="‡∏•‡∏≥‡∏•‡∏π‡∏Å‡∏Å‡∏≤">‡∏•‡∏≥‡∏•‡∏π‡∏Å‡∏Å‡∏≤</option>
                        <option value="‡∏™‡∏≤‡∏°‡πÇ‡∏Ñ‡∏Å">‡∏™‡∏≤‡∏°‡πÇ‡∏Ñ‡∏Å</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á *</label>
                    <div class="radio-group">
                        <label><input type="radio" name="wage_type" value="‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô" required> ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</label>
                        <label><input type="radio" name="wage_type" value="‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á"> ‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</label>
                        <label><input type="radio" name="wage_type" value="‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"> ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                        <label><input type="radio" name="wage_type" value="‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πâ‡∏≤‡∏á"> ‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πâ‡∏≤‡∏á</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="wage_amount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á (‡∏ö‡∏≤‡∏ó) *</label>
                    <input id="wage_amount" name="wage_amount" type="number" min="1" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" required>
                </div>
                
                <div class="form-group" id="lump_sum_group" style="display: none;">
                    <label for="lump_sum_days">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πâ‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πâ‡∏≤‡∏á)</label>
                    <input id="lump_sum_days" name="lump_sum_days" type="number" min="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô">
                </div>

                <div class="row">
                    <div class="form-group">
                        <label for="start_date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô *</label>
                        <input id="start_date" name="start_date" type="date" required>
                    </div>
                    <div class="form-group">
                        <label for="start_time">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô *</label>
                        <input id="start_time" name="start_time" type="time" required>
                    </div>
                </div>

                <button id="submitBtn" type="submit" disabled>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE‚Ä¶</button>
                <div id="status" class="status"></div>
                
            </form>
        </div>
        
        <div id="history-view" class="hidden history-view">
            <h2 style="color: #00b900;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î üìÑ</h2>
            <p id="history-message" style="font-size: 0.9em;">
                ‚úÖ **‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß** ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö <br>
                <span style="font-weight: bold; color: #d9534f;">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å</span> ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞
            </p>
            
            <div id="all-submission-history">
                </div>

            <button id="closeWindowBtn" class="history-action-btn" style="background-color: #5bc0de;">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        // ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ URL ‡∏ó‡∏µ‡πà Deploy ‡πÅ‡∏•‡πâ‡∏ß
        const LIFF_ID = "2008394776-k9v7m3Wg"; 
        const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbw_5J5oQpxCsn6BJoyexQRR0Lm6ddzF7ueSvHR4m52JPgiSnkM6ZwRkHnxw5sxd3aDknw/exec"; 
        // --- End CONFIG --- 

        const $ = id => document.getElementById(id);
        const form = $("f");
        const wageTypeRadios = document.getElementsByName('wage_type');

        let userProfile = {};
        let userIdToken = '';
        let liffReady = false;

        // UI Elements
        const helloDiv = $("hello");
        const submitBtn = $("submitBtn");
        const statusDiv = $("status");
        
        // Views
        const formView = $("form-view");
        const historyView = $("history-view");
        const allSubmissionHistory = $("all-submission-history"); 
        const closeWindowBtn = $("closeWindowBtn");

        // --- LIFF Initialization ---
        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                
                userProfile = await liff.getProfile();
                userIdToken = liff.getIDToken();
                liffReady = true;

                $("avatar").src = userProfile.pictureUrl;
                $("uid").textContent = `User ID: ${userProfile.userId.substring(0, 8)}...`;
                helloDiv.textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞, ${userProfile.displayName}`;
                
                const hasSubmitted = await checkSubmissionHistory(userProfile.userId);
                
                // ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ô‡∏µ‡πâ ‡πÄ‡∏£‡∏≤‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß (hasSubmitted) ‡∏à‡∏∞‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥)
                if (hasSubmitted) { 
                    showView('history');
                } else {
                    showView('form');
                }
                
                submitBtn.disabled = false;
                submitBtn.textContent = "‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏á‡∏≤‡∏ô";

            } catch (error) {
                console.error("LIFF initialization failed", error);
                helloDiv.textContent = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE";
            }
        }

        // --- Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á ---
        for (const radio of wageTypeRadios) {
            radio.addEventListener('change', function() {
                const lumpSumGroup = $('lump_sum_group');
                if (this.value === '‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πâ‡∏≤‡∏á') {
                    lumpSumGroup.style.display = 'block';
                    $('lump_sum_days').required = true;
                } else {
                    lumpSumGroup.style.display = 'none';
                    $('lump_sum_days').required = false;
                    $('lump_sum_days').value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤
                }
            });
        }

        // --- ‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---
        function showView(viewName) {
            if (viewName === 'form') {
                formView.classList.remove('hidden');
                historyView.classList.add('hidden');
            } else if (viewName === 'history') {
                formView.classList.add('hidden');
                historyView.classList.remove('hidden');
            }
        }

        // --- checkSubmissionHistory (‡∏£‡∏±‡∏ö Array 'submissions') ---
        async function checkSubmissionHistory(userId) {
            statusDiv.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°...";
            try {
                const checkUrl = `${GAS_ENDPOINT}?userId=${userId}`;
                const res = await fetch(checkUrl);
                const json = await res.json();
                
                if (json.status === "check_history" && json.hasSubmitted) {
                    // *** ‚ö†Ô∏è KEY CHANGE: ‡πÉ‡∏ä‡πâ json.submissions ***
                    renderHistoryList(json.submissions); 
                    return true; 
                } else {
                    statusDiv.textContent = "‚úÖ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏á‡∏≤‡∏ô";
                    return false; 
                }

            } catch (err) {
                console.error("Error checking history:", err);
                statusDiv.textContent = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡∏°‡πà";
                return false;
            }
        }

        // --- NEW FUNCTION: ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (List) ---
        function renderHistoryList(submissions) {
            if (!submissions || submissions.length === 0) {
                allSubmissionHistory.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏á‡∏≤‡∏ô</p>';
                return;
            }

            let html = '';
            
            // Field ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏ô Card ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö
            const summaryFields = {
                '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà-‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°': '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á',
                '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô': '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á',
                '‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•': '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó',
                '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'
            };

            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            submissions.forEach((data, index) => {
                const submissionNumber = submissions.length - index; 
                const isLatest = index === 0; 
                
                html += `
                <div class="history-card" style="border-left: 5px solid ${isLatest ? '#00b900' : '#ccc'}; margin-bottom: 20px;">
                    <p style="font-weight: bold; color: ${isLatest ? '#00b900' : '#333'}; margin-bottom: 10px;">
                        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏á‡∏≤‡∏ô #${submissionNumber} 
                        ${isLatest ? '**(‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)**' : ''}
                    </p>
                    
                    <div class="summary-list">
                `;
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏ô Card
                for (const key in summaryFields) {
                    if (data[key]) {
                         html += `
                            <div class="history-item">
                                <span class="history-label">${summaryFields[key]}:</span>
                                <span class="history-value">${data[key]}</span>
                            </div>
                        `;
                    }
                }
                
                html += `
                    </div>
                    <a href="#" onclick="showDetails(event, ${submissionNumber})" style="display: block; margin-top: 10px; font-size: 0.9em; color: #5bc0de;">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
                    <div id="details-${submissionNumber}" class="full-details hidden" style="margin-top: 10px; border-top: 1px dashed #eee; padding-top: 10px;">
                        ${renderFullDetails(data, summaryFields)}
                    </div>
                </div>
                `;
            });

            allSubmissionHistory.innerHTML = html;
        }

        // --- NEW FUNCTION: ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô) ---
        function renderFullDetails(data, summaryFields) {
            let detailHtml = '';
            for (const key in data) {
                 // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö Summary ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ
                if (!Object.keys(summaryFields).includes(key) && data[key]) {
                    detailHtml += `
                        <div class="history-item">
                            <span class="history-label">${key}:</span>
                            <span class="history-value">${data[key]}</span>
                        </div>
                    `;
                }
            }
            return detailHtml;
        }

        // --- NEW FUNCTION: Toggle ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ---
        window.showDetails = function(e, index) {
            e.preventDefault();
            const detailsDiv = $(`details-${index}`);
            const link = e.target;
            
            if (detailsDiv.classList.contains('hidden')) {
                detailsDiv.classList.remove('hidden');
                link.textContent = '‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
            } else {
                detailsDiv.classList.add('hidden');
                link.textContent = '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            }
        }

        // --- Form Submission Handler (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!liffReady) return;
            if (!$("pdpa_consent").checked) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏° PDPA ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°");
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";
            statusDiv.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
            
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            const payload = {
                idToken: userIdToken,
                profile: {
                    userId: userProfile.userId,
                    displayName: userProfile.displayName,
                },
                data: data 
            };

            try {
                const res = await fetch(GAS_ENDPOINT, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                    mode: 'no-cors' 
                });

                if (res.type === 'opaque') {
                    statusDiv.textContent = "‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...";
                    submitBtn.textContent = "‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
                    
                    await checkSubmissionHistory(userProfile.userId); 
                    showView('history'); 
                    return;
                }

            } catch (err) {
                statusDiv.textContent = "‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message;
                submitBtn.disabled = false;
                submitBtn.textContent = "‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏á‡∏≤‡∏ô";
            }
        });

        // Event listener ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
        closeWindowBtn.addEventListener('click', () => {
            if (liff.closeWindow) {
                liff.closeWindow();
            }
        });

        // Start LIFF
        initializeLiff();
    </script>
</body>
</html>
